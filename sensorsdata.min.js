import storage from"@system.storage";import nativeFetch from"@system.fetch";import device from"@system.device";import network from"@system.network";import router from"@system.router";import app from"@system.app";var sa={},_={};sa.para={name:"sensors",server_url:"",max_string_length:500,batch_send:!0,show_log:!1};var is_first_launch=!1,app_show_time=null;sa._queue=[],sa.getSystemInfoComplete=!1,sa.setPara=function(t){sa.para=_.extend2Lev(sa.para,t);var e={send_timeout:6e3,max_length:6};!0===sa.para.batch_send?sa.para.batch_send=_.extend({},e):_.isObject(sa.para.batch_send)?sa.para.batch_send=_.extend({},e,sa.para.batch_send):sa.para.batch_send=!1},sa.getServerUrl=function(){return sa.para.server_url};var ArrayProto=Array.prototype,FuncProto=Function.prototype,ObjProto=Object.prototype,slice=ArrayProto.slice,toString=ObjProto.toString,hasOwnProperty=ObjProto.hasOwnProperty,LIB_VERSION="0.9.1",LIB_NAME="QuickApp",logger="object"==typeof logger?logger:{};logger.info=function(){if(sa.para.show_log&&"object"==typeof console&&console.log)try{return console.log.apply(console,arguments)}catch(t){console.log(arguments[0])}};var nativeBind=FuncProto.bind,nativeForEach=ArrayProto.forEach,nativeIndexOf=ArrayProto.indexOf,nativeIsArray=Array.isArray,breaker={},each=_.each=function(t,e,n){if(null==t)return!1;if(nativeForEach&&t.forEach===nativeForEach)t.forEach(e,n);else if(t.length===+t.length){for(var r=0,i=t.length;r<i;r++)if(r in t&&e.call(n,t[r],r,t)===breaker)return!1}else for(var a in t)if(hasOwnProperty.call(t,a)&&e.call(n,t[a],a,t)===breaker)return!1};_.logger=logger,_.extend=function(t){return each(slice.call(arguments,1),function(e){for(var n in e)void 0!==e[n]&&(t[n]=e[n])}),t},_.extend2Lev=function(t){return each(slice.call(arguments,1),function(e){for(var n in e)void 0!==e[n]&&(_.isObject(e[n])&&_.isObject(t[n])?_.extend(t[n],e[n]):t[n]=e[n])}),t},_.coverExtend=function(t){return each(slice.call(arguments,1),function(e){for(var n in e)void 0!==e[n]&&void 0===t[n]&&(t[n]=e[n])}),t},_.isArray=nativeIsArray||function(t){return"[object Array]"===toString.call(t)},_.isFunction=function(t){try{return/^\s*\bfunction\b/.test(t)}catch(t){return!1}},_.isArguments=function(t){return!(!t||!hasOwnProperty.call(t,"callee"))},_.toArray=function(t){return t?t.toArray?t.toArray():_.isArray(t)?slice.call(t):_.isArguments(t)?slice.call(t):_.values(t):[]},_.values=function(t){var e=[];return null==t?e:(each(t,function(t){e[e.length]=t}),e)},_.include=function(t,e){var n=!1;return null==t?n:nativeIndexOf&&t.indexOf===nativeIndexOf?-1!=t.indexOf(e):(each(t,function(t){if(n||(n=t===e))return breaker}),n)},_.trim=function(t){return t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")},_.isObject=function(t){return"[object Object]"==toString.call(t)&&null!=t},_.isEmptyObject=function(t){if(_.isObject(t)){for(var e in t)if(hasOwnProperty.call(t,e))return!1;return!0}return!1},_.isUndefined=function(t){return void 0===t},_.isString=function(t){return"[object String]"==toString.call(t)},_.isDate=function(t){return"[object Date]"==toString.call(t)},_.isBoolean=function(t){return"[object Boolean]"==toString.call(t)},_.isNumber=function(t){return"[object Number]"==toString.call(t)&&/[\d\.]+/.test(String(t))},_.isJSONString=function(t){try{JSON.parse(t)}catch(t){return!1}return!0},_.decodeURIComponent=function(t){var e="";try{e=decodeURIComponent(t)}catch(n){e=t}return e},_.encodeDates=function(t){return _.each(t,function(e,n){_.isDate(e)?t[n]=_.formatDate(e):_.isObject(e)&&(t[n]=_.encodeDates(e))}),t},_.formatDate=function(t){function e(t){return t<10?"0"+t:t}return t.getFullYear()+"-"+e(t.getMonth()+1)+"-"+e(t.getDate())+" "+e(t.getHours())+":"+e(t.getMinutes())+":"+e(t.getSeconds())+"."+e(t.getMilliseconds())},_.searchObjDate=function(t){_.isObject(t)&&_.each(t,function(e,n){_.isObject(e)?_.searchObjDate(t[n]):_.isDate(e)&&(t[n]=_.formatDate(e))})},_.formatString=function(t){return t.length>sa.para.max_string_length?(logger.info("字符串长度超过限制，已经做截取--"+t),t.slice(0,sa.para.max_string_length)):t},_.searchObjString=function(t){_.isObject(t)&&_.each(t,function(e,n){_.isObject(e)?_.searchObjString(t[n]):_.isString(e)&&(t[n]=_.formatString(e))})},_.unique=function(t){for(var e,n=[],r={},i=0;i<t.length;i++)(e=t[i])in r||(r[e]=!0,n.push(e));return n},_.strip_sa_properties=function(t){return _.isObject(t)?(_.each(t,function(e,n){if(_.isArray(e)){var r=[];_.each(e,function(t){_.isString(t)?r.push(t):logger.info("您的数据-",e,"的数组里的值必须是字符串,已经将其删除")}),0!==r.length?t[n]=r:(delete t[n],logger.info("已经删除空的数组"))}_.isString(e)||_.isNumber(e)||_.isDate(e)||_.isBoolean(e)||_.isArray(e)||(logger.info("您的数据-",e,"-格式不满足要求，我们已经将其删除"),delete t[n])}),t):t},_.strip_empty_properties=function(t){var e={};return _.each(t,function(t,n){null!=t&&(e[n]=t)}),e},_.utf8Encode=function(t){var e,n,r,i,a="";for(e=n=0,r=(t=(t+"").replace(/\r\n/g,"\n").replace(/\r/g,"\n")).length,i=0;i<r;i++){var s=t.charCodeAt(i),o=null;s<128?n++:o=s>127&&s<2048?String.fromCharCode(s>>6|192,63&s|128):String.fromCharCode(s>>12|224,s>>6&63|128,63&s|128),null!==o&&(n>e&&(a+=t.substring(e,n)),a+=o,e=n=i+1)}return n>e&&(a+=t.substring(e,t.length)),a},_.base64Encode=function(t){var e,n,r,i,a,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",o=0,c=0,u="",f=[];if(!t)return t;t=_.utf8Encode(t);do{e=(a=t.charCodeAt(o++)<<16|t.charCodeAt(o++)<<8|t.charCodeAt(o++))>>18&63,n=a>>12&63,r=a>>6&63,i=63&a,f[c++]=s.charAt(e)+s.charAt(n)+s.charAt(r)+s.charAt(i)}while(o<t.length);switch(u=f.join(""),t.length%3){case 1:u=u.slice(0,-2)+"==";break;case 2:u=u.slice(0,-1)+"="}return u},sa._=_,sa.store={getUUID:function(){return Date.now()+"-"+Math.floor(1e7*Math.random())+"-"+Math.random().toString(16).replace(".","")+"-"+String(31242*Math.random()).replace(".","").slice(0,8)},getStorage:function(t){storage.get({key:"sensorsdata2015_quickapp",success:function(e){t(e)},fail:function(t,e){logger.info("获取storage失败-会导致解析distinct_id异常",t,e)}})},_state:{},mem:{mdata:[],getLength:function(){return this.mdata.length},add:function(t){this.mdata.push(t)},clear:function(t){this.mdata.splice(0,t)}},toState:function(t){var e=null;_.isJSONString(t)?(e=JSON.parse(t)).distinct_id?this._state=e:this.set("distinct_id",this.getUUID()):_.isObject(t)&&(e=t).distinct_id?this._state=e:this.set("distinct_id",this.getUUID())},getFirstId:function(){return this._state.first_id},getDistinctId:function(){return this._state.distinct_id},getProps:function(){return this._state.props||{}},getUnionId:function(){var t={},e=this._state.first_id,n=this._state.distinct_id;return e&&n?(t.login_id=n,t.anonymous_id=e):t.anonymous_id=n,t},setProps:function(t,e){var n=this._state.props||{};e?this.set("props",t):(_.extend(n,t),this.set("props",n))},set:function(t,e){var n={};for(var r in"string"==typeof t?n[t]=e:"object"==typeof t&&(n=t),this._state=this._state||{},n)this._state[r]=n[r],"distinct_id"===r&&sa.events.emit("changeDistinctId");this.save()},change:function(t,e){this._state[t]=e},save:function(){storage.set({key:"sensorsdata2015_quickapp",value:JSON.stringify(this._state),fail:function(t,e){logger.info("存储storage数据失败",t,e)}})},init:function(){var t=this;this.getStorage(function(e){var n=e;if(n)t.toState(n);else{is_first_launch=!0;var r=new Date,i=r.getTime();r.setHours(23),r.setMinutes(59),r.setSeconds(60),t.set({distinct_id:t.getUUID(),first_visit_time:i,first_visit_day_time:r.getTime()})}sa.initialState.storeIsComplete=!0,sa.events.emit("initStore"),sa.initialState.checkIsComplete()})}},_.formatPath=function(t){return t="string"==typeof t?t.replace(/^\//,""):"取值异常"},_.getCurrentPath=function(){var t=router.getState();return"object"==typeof t?t.path:""},_.getCurrentTitle=function(){var t=router.getState();return"object"==typeof t?t.name:""},_.getCurrentSource=function(){var t=app.getInfo(),e={$source_package_name:"",$scene:""};return"object"==typeof t&&"object"==typeof t.source&&(e.$source_package_name=t.source.packageName||"",e.$scene=t.source.type||""),e},_.getIsFirstDay=function(){return"object"==typeof sa.store._state&&"number"==typeof sa.store._state.first_visit_day_time&&sa.store._state.first_visit_day_time>(new Date).getTime()},_.eventEmitter=function(){this.sub=[]},_.eventEmitter.prototype={add:function(t){this.sub.push(t)},emit:function(t,e){this.sub.forEach(function(n){n.on(t,e)})}},_.eventSub=function(t){sa.events.add(this),this._events=[],this.handle=t,this.ready=!1},_.eventSub.prototype={on:function(t,e){if(this.ready){if(_.isFunction(this.handle))try{this.handle(t,e)}catch(t){logger.info(t)}}else this._events.push({event:t,data:e})},isReady:function(){var t=this;t.ready=!0,t._events.forEach(function(e){if(_.isFunction(t.handle))try{t.handle(e.event,e.data)}catch(t){logger.info(t)}})}},_.info={currentProps:{},properties:{$lib:LIB_NAME,$lib_version:String(LIB_VERSION)},getSystem:function(){var t=this.properties;function e(){device.getInfo({success:function(e){t.$screen_width=Number(e.screenWidth),t.$screen_height=Number(e.screenHeight),t.$os=e.osType,t.$model=e.model,t.$os_version=e.osVersionName,t.$brand=e.brand,t.$manufacturer=e.manufacturer},complete:function(){var e=(new Date).getTimezoneOffset(),n=app.getInfo().packageName;n&&(t.$app_id=n),_.isNumber(e)&&(t.$timezone_offset=e),sa.initialState.systemIsComplete=!0,sa.initialState.checkIsComplete()}})}network.getType({success:function(e){t.$network_type=e.type},complete:e})}},sa.eventSub=_.eventSub,sa.events=new _.eventEmitter,sa.initialState={queue:[],isComplete:!1,systemIsComplete:!1,storeIsComplete:!1,checkIsComplete:function(){this.systemIsComplete&&this.storeIsComplete&&(this.isComplete=!0,this.queue.length>0&&(_.each(this.queue,function(t){sa[t[0]].apply(sa,slice.call(t[1]))}),sa.queue=[]))}},sa.prepareData=function(t,e){var n={distinct_id:this.store.getDistinctId(),lib:{$lib:LIB_NAME,$lib_method:"code",$lib_version:String(LIB_VERSION)},properties:{}};_.extend(n,t),_.isObject(t.properties)&&!_.isEmptyObject(t.properties)&&_.extend(n.properties,t.properties),t.type&&"profile"===t.type.slice(0,7)||(n._track_id=Number(String(Math.random()).slice(2,5)+String(Math.random()).slice(2,4)+String(Date.now()).slice(-4)),n.properties=_.extend({},_.info.properties,sa.store.getProps(),_.info.currentProps,n.properties),"$AppStart"===n.event&&(n.properties.$is_first_time=!!is_first_launch),n.properties.$is_first_day=_.getIsFirstDay()),n.properties.$time&&_.isDate(n.properties.$time)?(n.time=1*n.properties.$time,delete n.properties.$time):n.time=1*new Date,_.searchObjDate(n),_.searchObjString(n),sa.para.batch_send?sa.sendStrategy.send(n):sa.send(n,e)},sa.track=function(t,e,n){this.prepareData({type:"track",event:t,properties:e},n)},sa.identify=function(t,e){if("number"==typeof t)t=String(t);else if("string"!=typeof t)return!1;var n=sa.store.getFirstId();!0===e?n?sa.store.set("first_id",t):sa.store.set("distinct_id",t):n?sa.store.change("first_id",t):sa.store.change("distinct_id",t)},sa.trackSignup=function(t,e,n,r){sa.prepareData({original_id:sa.store.getFirstId()||sa.store.getDistinctId(),distinct_id:t,type:"track_signup",event:e,properties:n},r),sa.store.set("distinct_id",t)},sa.registerApp=function(t){_.isObject(t)&&!_.isEmptyObject(t)&&(_.info.currentProps=_.extend(_.info.currentProps,t))},sa.clearAllRegister=function(){sa.store.setProps({},!0)},sa.login=function(t){var e=sa.store.getFirstId(),n=sa.store.getDistinctId();t!==n&&(e?sa.trackSignup(t,"$SignUp"):(sa.store.set("first_id",n),sa.trackSignup(t,"$SignUp")))},sa.getAnonymousID=function(){if(!_.isEmptyObject(sa.store._state))return sa.store._state.first_id||sa.store._state.distinct_id;logger.info("请先初始化SDK")},sa.logout=function(t){var e=sa.store.getFirstId();e?(sa.store.set("first_id",""),!0===t?sa.store.set("distinct_id",sa.store.getUUID()):sa.store.set("distinct_id",e)):logger.info("没有first_id，logout失败")},sa.setProfile=function(t,e){sa.prepareData({type:"profile_set",properties:t},e)},sa.setOnceProfile=function(t,e){sa.prepareData({type:"profile_set_once",properties:t},e)},sa.init=function(t){this._.info.getSystem(),this.store.init(),"object"==typeof t&&(t[sa.para.name]=sa),sa.para.batch_send&&sa.sendStrategy.init()},sa.send=function(t){var e="";t._nocache=(String(Math.random())+String(Math.random())+String(Math.random())).slice(2,15),logger.info(t),t._flush_time=Date.now(),t=JSON.stringify(t),e=-1!==sa.para.server_url.indexOf("?")?sa.para.server_url+"&data="+encodeURIComponent(_.base64Encode(t)):sa.para.server_url+"?data="+encodeURIComponent(_.base64Encode(t));nativeFetch.fetch({data:"String",responseType:"text",method:"GET",url:e})},sa.usePlugin=function(t,e){"function"==typeof t.init&&t.init(sa,e)},sa.use=function(t,e){"function"==typeof t.init&&t.init(sa,e)},sa.sendStrategy={dataHasSend:!0,syncStorage:!1,is_first_batch_write:!0,failTime:0,init:function(){storage.get({key:"sensors_prepare_data",complete:function(t){var e=t.data&&_.isArray(t.data)?t.data:[];sa.store.mem.mdata=e.concat(sa.store.mem.mdata),sa.sendStrategy.syncStorage=!0}}),this.batchInterval()},onAppHide:function(){sa.para.batch_send&&this.batchSend()},send:function(t){if(!sa.para.server_url)return!1;this.dataHasChange=!0,sa.store.mem.getLength()>=500&&(logger.info("数据量存储过大，有异常"),sa.store.mem.mdata.shift()),logger.info(t),sa.store.mem.add(t),sa.store.mem.getLength()>=sa.para.batch_send.max_length&&this.batchSend()},batchWrite:function(){var t=this;this.dataHasChange&&(this.is_first_batch_write&&(this.is_first_batch_write=!1,setTimeout(function(){t.batchSend()},1e3)),this.syncStorage&&storage.set({key:"sensors_prepare_data",value:sa.store.mem.mdata,success:function(e){t.dataHasChange=!1}}))},batchInterval(){var t=this;!function e(){setTimeout(function(){t.batchSend(),e()},sa.para.batch_send.send_timeout*Math.pow(2,t.failTime))}(),function e(){setTimeout(function(){t.batchWrite(),e()},500)}()},batchSend(){if(this.dataHasSend){var t,e,n=this,r=sa.store.mem.mdata;if(t=r.length>=100?r.slice(0,100):r,e=t.length,_.isArray(t)&&t.length>0){this.dataHasSend=!1;var i=Date.now();t.forEach(function(t){t._flush_time=i}),t=JSON.stringify(t),t="data_list="+encodeURIComponent(_.base64Encode(t)),nativeFetch.fetch({url:sa.para.server_url,method:"POST",data:t,responseType:"text",success:function(t){n.batchRemove(e)},fail:function(t){n.sendFail()}})}}},batchRemove(t){this.dataHasSend=!0,this.dataHasChange=!0,sa.store.mem.clear(t),this.batchWrite(),this.failTime=0},sendFail(){this.dataHasSend=!0,this.failTime++}},sa.appLaunch=function(t){t&&_.isObject(t)||(t={});var e={};_.extend(e,t),_.extend(e,_.getCurrentSource()),sa.track("$AppStart",e)},sa.pageShow=function(t){t&&_.isObject(t)||(t={});var e={};e.$url_path=_.getCurrentPath(),e.$title=_.getCurrentTitle(),_.extend(e,_.getCurrentSource()),_.extend(e,t),sa.track("$AppViewScreen",e)},sa.appHide=function(t){t&&_.isObject(t)||(t={});var e={};e.$url_path=_.getCurrentPath(),e.$title=_.getCurrentTitle(),_.extend(e,t),sa.track("$AppEnd",e)},_.each(["setProfile","pageShow","appHide","login","logout","identify","appLaunch","setOnceProfile","track","clearAllRegister","quick","incrementProfile","appendProfile"],function(t){var e=sa[t];sa[t]&&(sa[t]=function(){sa.initialState.isComplete?e.apply(sa,arguments):sa.initialState.queue.push([t,arguments])})});export default sa;